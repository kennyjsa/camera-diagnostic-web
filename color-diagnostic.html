<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnóstico de Cores de Câmera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .wizard-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .video-preview {
      width: 100%;
      max-width: 640px;
      height: auto;
      border: 2px solid #007bff;
      border-radius: 8px;
      margin: 20px auto;
      display: block;
      background: #000;
    }

    .capture-comparison {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .capture-panel {
      flex: 1;
      min-width: 250px;
      max-width: 400px;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .capture-panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .capture-panel.selected {
      border: 3px solid #28a745;
      background: #f0fff4;
    }

    .capture-panel h4 {
      margin-bottom: 15px;
      text-align: center;
    }

    .capture-panel.original h4 {
      color: #007bff;
    }

    .capture-panel.swapped h4 {
      color: #dc3545;
    }

    .capture-panel img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      display: block;
    }

    .progress-bar-container {
      margin: 20px 0;
    }

    .card {
      margin-bottom: 20px;
    }

    .btn-group-wizard {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 30px;
    }

    .summary-item {
      padding: 10px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }

    .summary-item.success {
      border-left-color: #28a745;
    }

    .summary-item.error {
      border-left-color: #dc3545;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container py-5 wizard-container">
    <div class="text-center mb-4">
      <h1><i class="bi bi-palette-fill"></i> Diagnóstico de Cores de Câmera</h1>
      <p class="text-muted">Teste todas as câmeras do seu dispositivo para identificar problemas de inversão de cores</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
      <div class="progress" style="height: 30px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar"
          style="width: 0%">
          <span id="progressText">Iniciando...</span>
        </div>
      </div>
    </div>

    <!-- Step 1: Inicialização -->
    <div class="step active" id="stepInit">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-hourglass-split"></i> Inicializando
        </div>
        <div class="card-body text-center">
          <p>Detectando câmeras disponíveis...</p>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Teste de Câmera -->
    <div class="step" id="stepCamera">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <i class="bi bi-camera-video-fill"></i> Teste de Câmera <span id="cameraNumber"></span>
        </div>
        <div class="card-body">
          <h5 id="cameraName" class="mb-3"></h5>
          <video id="videoPreview" class="video-preview" autoplay muted playsinline></video>
          <div class="text-center">
            <button class="btn btn-success btn-lg" id="captureBtn" onclick="capturePhoto()">
              <i class="bi bi-camera-fill"></i> Capturar Foto
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Pergunta sobre o vídeo -->
    <div class="step" id="stepVideoQuestion">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <i class="bi bi-question-circle"></i> Como o vídeo apareceu?
        </div>
        <div class="card-body">
          <h5 class="mb-4">Durante a captura, as cores do vídeo apareceram:</h5>
          <div class="d-grid gap-3">
            <button class="btn btn-outline-primary btn-lg" onclick="setVideoAppearance('normal')">
              <i class="bi bi-check-circle"></i> Normal (cores corretas)
            </button>
            <button class="btn btn-outline-danger btn-lg" onclick="setVideoAppearance('inverted')">
              <i class="bi bi-arrow-left-right"></i> Invertidas (azul aparecendo como vermelho)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Comparação de Fotos -->
    <div class="step" id="stepPhotoComparison">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <i class="bi bi-images"></i> Qual foto está com as cores corretas?
        </div>
        <div class="card-body">
          <p class="text-center mb-4">Clique na foto que representa as cores corretas:</p>
          <div class="capture-comparison">
            <div class="capture-panel original" id="originalPanel" onclick="selectPhoto('original')">
              <h4><i class="bi bi-camera"></i> Foto Original</h4>
              <img id="originalPhoto" src="" alt="Foto Original">
            </div>
            <div class="capture-panel swapped" id="swappedPanel" onclick="selectPhoto('swapped')">
              <h4><i class="bi bi-arrow-left-right"></i> Foto com Canais Invertidos</h4>
              <img id="swappedPhoto" src="" alt="Foto com Canais Invertidos">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5: Resumo -->
    <div class="step" id="stepSummary">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="bi bi-list-check"></i> Resumo dos Testes
        </div>
        <div class="card-body">
          <div id="summaryContent"></div>
          <div class="btn-group-wizard">
            <button class="btn btn-primary btn-lg" onclick="restartWizard()">
              <i class="bi bi-arrow-clockwise"></i> Testar Novamente
            </button>
            <button class="btn btn-success btn-lg" id="submitBtn" onclick="submitDiagnostic()">
              <i class="bi bi-send-fill"></i> Enviar Diagnóstico
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulário Netlify -->
    <form name="colorDiagnostic" method="POST" action="/thankyou.html" netlify-honeypot="bot-field" data-netlify="true">
      <p class="hidden">
        <label>
          Don't fill this out if you're human: <input name="bot-field" type="text" />
        </label>
      </p>
      <input type="hidden" name="form-name" value="colorDiagnostic" />
      <input type="hidden" name="debugId" />
      <input type="hidden" name="deviceDate" />
      <input type="hidden" name="browserName" />
      <input type="hidden" name="browserVersion" />
      <input type="hidden" name="os" />
      <input type="hidden" name="language" />
      <input type="hidden" name="cameraTests" />
      <input type="hidden" name="userAgent" />
    </form>
  </div>

  <script>
    let cameras = [];
    let currentCameraIndex = -1;
    let currentStream = null;
    let diagnosticData = {
      tests: [],
      startTime: Date.now()
    };

    // Inicialização
    async function init() {
      try {
        // Solicita permissão de câmera
        await navigator.mediaDevices.getUserMedia({ video: true });

        // Enumera dispositivos
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(d => d.kind === 'videoinput');

        if (cameras.length === 0) {
          alert('Nenhuma câmera encontrada!');
          return;
        }

        updateProgress(0, `Encontradas ${cameras.length} câmera(s)`);
        await delay(1000);

        // Inicia o primeiro teste
        startNextCameraTest();
      } catch (error) {
        alert('Erro ao acessar câmeras: ' + error.message);
        console.error(error);
      }
    }

    // Inicia o teste da próxima câmera
    async function startNextCameraTest() {
      currentCameraIndex++;

      if (currentCameraIndex >= cameras.length) {
        // Todas as câmeras foram testadas
        showSummary();
        return;
      }

      const camera = cameras[currentCameraIndex];
      updateProgress(
        ((currentCameraIndex + 1) / cameras.length) * 100,
        `Testando câmera ${currentCameraIndex + 1} de ${cameras.length}: ${camera.label || 'Sem nome'}`
      );

      // Para o stream anterior se existir
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      // Mostra o step da câmera
      showStep('stepCamera');
      document.getElementById('cameraNumber').textContent = `${currentCameraIndex + 1} de ${cameras.length}`;
      document.getElementById('cameraName').textContent = camera.label || `Câmera ${currentCameraIndex + 1}`;

      try {
        // Inicia stream da câmera
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: camera.deviceId } },
          audio: false
        });

        const videoPreview = document.getElementById('videoPreview');
        videoPreview.srcObject = currentStream;
        document.getElementById('captureBtn').disabled = false;
      } catch (error) {
        console.error('Erro ao iniciar stream:', error);
        // Adiciona erro aos dados e continua para próxima câmera
        diagnosticData.tests.push({
          cameraIndex: currentCameraIndex,
          deviceId: camera.deviceId,
          label: camera.label || `Câmera ${currentCameraIndex + 1}`,
          error: error.message,
          skipped: true
        });
        await delay(1000);
        startNextCameraTest();
      }
    }

    // Captura foto
    function capturePhoto() {
      const videoPreview = document.getElementById('videoPreview');
      const canvas = document.createElement('canvas');
      canvas.width = videoPreview.videoWidth;
      canvas.height = videoPreview.videoHeight;
      const ctx = canvas.getContext('2d');

      // Desenha o frame atual
      ctx.drawImage(videoPreview, 0, 0);

      // Cria versão original
      const originalDataUrl = canvas.toDataURL('image/jpeg', 0.9);

      // Cria versão com canais invertidos
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const b = data[i + 2];
        data[i] = b;
        data[i + 2] = r;
      }

      ctx.putImageData(imageData, 0, 0);
      const swappedDataUrl = canvas.toDataURL('image/jpeg', 0.9);

      // Armazena as fotos temporariamente
      window.currentPhotos = {
        original: originalDataUrl,
        swapped: swappedDataUrl
      };

      // Para o stream
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }

      // Mostra a pergunta sobre o vídeo
      showStep('stepVideoQuestion');
    }

    // Define como o vídeo apareceu
    function setVideoAppearance(appearance) {
      if (!window.currentPhotos) return;

      // Armazena a resposta temporariamente
      window.currentVideoAppearance = appearance;

      // Mostra as fotos para comparação
      document.getElementById('originalPhoto').src = window.currentPhotos.original;
      document.getElementById('swappedPhoto').src = window.currentPhotos.swapped;

      // Remove seleção anterior
      document.getElementById('originalPanel').classList.remove('selected');
      document.getElementById('swappedPanel').classList.remove('selected');

      showStep('stepPhotoComparison');
    }

    // Seleciona qual foto está correta
    function selectPhoto(choice) {
      if (!window.currentPhotos || !window.currentVideoAppearance) return;

      const camera = cameras[currentCameraIndex];

      // Adiciona resultado aos dados
      diagnosticData.tests.push({
        cameraIndex: currentCameraIndex,
        deviceId: camera.deviceId,
        label: camera.label || `Câmera ${currentCameraIndex + 1}`,
        videoAppearance: window.currentVideoAppearance,
        correctPhoto: choice,
        originalPhoto: window.currentPhotos.original,
        swappedPhoto: window.currentPhotos.swapped,
        timestamp: new Date().toISOString()
      });

      // Limpa dados temporários
      delete window.currentPhotos;
      delete window.currentVideoAppearance;

      // Aguarda um pouco e vai para próxima câmera
      setTimeout(() => {
        startNextCameraTest();
      }, 500);
    }

    // Mostra resumo
    function showSummary() {
      updateProgress(100, 'Testes concluídos!');
      showStep('stepSummary');

      const summaryContent = document.getElementById('summaryContent');
      let html = '';

      diagnosticData.tests.forEach((test, index) => {
        const statusClass = test.error ? 'error' : 'success';
        const statusIcon = test.error ? '❌' : '✅';
        html += `
          <div class="summary-item ${statusClass}">
            <strong>${statusIcon} Câmera ${index + 1}:</strong> ${test.label || 'Sem nome'}<br>
            ${test.error ? 
              `<small class="text-danger">Erro: ${test.error}</small>` :
              `<small>
                Vídeo: ${test.videoAppearance === 'normal' ? 'Normal' : 'Invertido'}<br>
                Foto correta: ${test.correctPhoto === 'original' ? 'Original' : 'Com canais invertidos'}
              </small>`
            }
          </div>
        `;
      });

      summaryContent.innerHTML = html || '<p class="text-muted">Nenhum teste realizado.</p>';
    }

    // Envia diagnóstico
    function submitDiagnostic() {
      const form = document.forms['colorDiagnostic'];
      const debugId = Date.now().toString();
      const deviceDate = new Date().toISOString();

      // Informações do navegador
      const ua = navigator.userAgent;
      const platform = navigator.platform;
      const language = navigator.language;
      const browserInfo = parseUserAgent(ua);

      // Preenche formulário
      form.debugId.value = debugId;
      form.deviceDate.value = deviceDate;
      form.browserName.value = browserInfo.name;
      form.browserVersion.value = browserInfo.version;
      form.os.value = platform;
      form.language.value = language;
      form.userAgent.value = ua;
      form.cameraTests.value = JSON.stringify(diagnosticData.tests);

      // Envia
      form.submit();
    }

    // Reinicia wizard
    function restartWizard() {
      currentCameraIndex = -1;
      diagnosticData.tests = [];
      diagnosticData.startTime = Date.now();
      delete window.currentPhotos;
      delete window.currentVideoAppearance;

      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }

      init();
    }

    // Utilitários
    function showStep(stepId) {
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
      document.getElementById(stepId).classList.add('active');
    }

    function updateProgress(percentage, text) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressBar.style.width = percentage + '%';
      progressText.textContent = text || `${Math.round(percentage)}%`;
    }

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function parseUserAgent(ua) {
      let name = "Desconhecido", version = "0";
      if (ua.includes("Chrome/")) {
        name = "Chrome";
        version = ua.split("Chrome/")[1].split(" ")[0];
      } else if (ua.includes("Firefox/")) {
        name = "Firefox";
        version = ua.split("Firefox/")[1];
      } else if (ua.includes("Safari/") && ua.includes("Version/")) {
        name = "Safari";
        version = ua.split("Version/")[1].split(" ")[0];
      } else if (ua.includes("Edg/")) {
        name = "Edge";
        version = ua.split("Edg/")[1];
      }
      return { name, version };
    }

    // Inicia quando a página carrega
    window.addEventListener('load', () => {
      init();
    });

    // Limpa streams ao sair
    window.addEventListener('beforeunload', () => {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>

</html>

