<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagn√≥stico de C√¢mera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .terminal {
      background: rgb(33, 37, 41);
      color: #0f0;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>

  <div class="container py-5" style="max-width: 600px;">
    <div class="text-center mb-4">
      <h1><i class="bi bi-camera-video-fill"></i> Diagn√≥stico de C√¢mera</h1>
      <p class="text-muted">Verifique o funcionamento da sua c√¢mera, navegador e permiss√µes.</p>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header bg-dark text-white">
        <i class="bi bi-terminal"></i> Terminal de Diagn√≥stico
      </div>
      <div class="terminal" id="log">üü¢ Aguardando in√≠cio do diagn√≥stico...</div>
    </div>

    <!-- Device Info Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-info text-white">
        <i class="bi bi-phone"></i> Identifica√ß√£o do Dispositivo
      </div>
      <div class="card-body">
        <div class="mb-2">
          <strong>Modelo:</strong> <span id="deviceModel">Detectando...</span>
        </div>
        <div class="mb-2">
          <strong>Chave Whitelist:</strong> <code id="deviceKey" class="bg-light p-1 rounded">...</code>
        </div>
        <div class="mb-3">
          <strong>User-Agent:</strong> <small class="text-muted d-block" id="userAgentDisplay"
            style="word-break: break-all;">...</small>
        </div>
      </div>
    </div>

    <div class="d-grid gap-3">
      <button class="btn btn-primary btn-lg" id="iniciarBtn" onclick="iniciarDiagnostico()">
        <i class="bi bi-camera-video-fill me-1"></i> Iniciar Diagn√≥stico
      </button>
    </div>

    <form name="diagnostico" method="POST" netlify-honeypot="bot-field" data-netlify="true">
      <p class="hidden">
        <label>
          Don‚Äôt fill this out if you‚Äôre human: <input name="bot-field" type="text" />
        </label>
      </p>
      <input type="hidden" name="form-name" value="diagnostico" />
      <input type="hidden" name="debugId" />
      <input type="hidden" name="deviceDate" />
      <input type="hidden" name="elapsedTimeMs" />
      <input type="hidden" name="browserName" />
      <input type="hidden" name="browserVersion" />
      <input type="hidden" name="os" />
      <input type="hidden" name="language" />
      <input type="hidden" name="cameraCount" />
      <input type="hidden" name="supportsMediaDevices" />
      <input type="hidden" name="permissionsCamera" />
      <input type="hidden" name="permissionsMicrophone" />
      <input type="hidden" name="cameraInfo" />
      <input type="hidden" name="errors" />


      <div class="d-grid mt-3">
        <button class="btn btn-success btn-lg" type="submit" id="enviarBtn" onclick="enviarDiagnostico()"
          style="display:none">
          <i class="bi bi-clipboard-check me-1"></i> Enviar Diagn√≥stico
        </button>
      </div>
    </form>
  </div>

  <script>
    // toda a l√≥gica JS mantida aqui
    (function () {
      const logEl = document.getElementById('log');
      const enviarBtn = document.getElementById('enviarBtn');
      const iniciarBtn = document.getElementById('iniciarBtn');
      const form = document.forms['diagnostico'];
      let startTime;

      const log = (text) => {
        logEl.textContent += `\n${text}`;
        logEl.scrollTop = logEl.scrollHeight;
      };

      const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      async function iniciarDiagnostico() {
        startTime = Date.now();
        iniciarBtn.disabled = true;
        logEl.textContent = "‚è≥ Iniciando diagn√≥stico...\n";
        const errors = [];

        const debugId = Date.now().toString();
        const deviceDate = new Date().toISOString();

        log("üîç Coletando informa√ß√µes do navegador...");
        await delay(300);
        const ua = navigator.userAgent;
        const platform = navigator.platform;
        const language = navigator.language;

        const browserInfo = parseUserAgent(ua);
        form.browserName.value = browserInfo.name;
        form.browserVersion.value = browserInfo.version;
        form.os.value = platform;
        form.language.value = language;
        form.debugId.value = debugId;
        form.deviceDate.value = deviceDate;
        log("‚úÖ Navegador: " + browserInfo.name + " " + browserInfo.version);

        const supports = !!navigator.mediaDevices?.getUserMedia;
        form.supportsMediaDevices.value = supports;
        if (!supports) {
          errors.push("Navegador n√£o suporta mediaDevices.getUserMedia");
          log("‚ùå Navegador n√£o suporta getUserMedia.");
        }

        try {
          log("üé• Solicitando permiss√£o de c√¢mera...");
          await navigator.mediaDevices.getUserMedia({ video: true });
          log("‚úÖ Permiss√£o concedida.");
        } catch (e) {
          log("‚ùå Erro ao acessar c√¢mera: " + e.message);
          errors.push("Erro ao acessar c√¢mera: " + e.message);
        }

        try {
          const [camPerm, micPerm] = await Promise.all([
            navigator.permissions.query({ name: 'camera' }),
            navigator.permissions.query({ name: 'microphone' })
          ]);
          form.permissionsCamera.value = camPerm.state;
          form.permissionsMicrophone.value = micPerm.state;
          log(`üìã Permiss√µes: c√¢mera=${camPerm.state}, microfone=${micPerm.state}`);
        } catch {
          form.permissionsCamera.value = 'unsupported';
          form.permissionsMicrophone.value = 'unsupported';
          log("‚ö†Ô∏è Permiss√µes n√£o suportadas.");
        }

        let cameraData = [];
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cameras = devices.filter(d => d.kind === 'videoinput');
          form.cameraCount.value = cameras.length;
          log(`üîé ${cameras.length} c√¢mera(s) detectada(s).`);

          for (let i = 0; i < cameras.length; i++) {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: cameras[i].deviceId } });
              const track = stream.getVideoTracks()[0];
              const data = {
                deviceId: cameras[i].deviceId,
                label: cameras[i].label,
                capabilities: track.getCapabilities?.() || {},
                settings: track.getSettings?.() || {},
                constraints: track.getConstraints?.() || {},
              };
              stream.getTracks().forEach(t => t.stop());
              cameraData.push(data);
              log(`üì∑ ${i + 1}: ${data.label || 'Sem nome'}`);
            } catch (e) {
              errors.push(`Erro na c√¢mera ${i + 1}: ` + e.message);
              log(`‚ùå Erro na c√¢mera ${i + 1}: ` + e.message);
            }
          }

          form.cameraInfo.value = JSON.stringify(cameraData);
        } catch (e) {
          errors.push("Erro ao enumerar dispositivos: " + e.message);
          log("‚ùå Erro ao enumerar dispositivos.");
        }

        form.elapsedTimeMs.value = Date.now() - startTime;
        form.errors.value = JSON.stringify(errors);

        if (errors.length > 0) {
          log("\n‚ö†Ô∏è Diagn√≥stico conclu√≠do com erros.");
        } else {
          log("\n‚úÖ Diagn√≥stico conclu√≠do com sucesso.");
        }

        enviarBtn.style.display = 'inline-block';
      }

      function enviarDiagnostico() {
        log("\nüì§ Enviando diagn√≥stico...");
        form.submit();
        iniciarBtn.style.display = 'none';
        enviarBtn.style.display = 'none';
        log("‚úÖ Enviado! Redirecionando...");
        const currentPage = window.location.pathname.split('/').pop() || 'camera-diagnostic.html';
        setTimeout(() => {
          window.location.href = `/thankyou.html?from=${encodeURIComponent(currentPage)}`;
        }, 1000);
      }

      function parseUserAgent(ua) {
        let name = "Desconhecido", version = "0";
        if (ua.includes("Chrome/")) {
          name = "Chrome";
          version = ua.split("Chrome/")[1].split(" ")[0];
        } else if (ua.includes("Firefox/")) {
          name = "Firefox";
          version = ua.split("Firefox/")[1];
        } else if (ua.includes("Safari/") && ua.includes("Version/")) {
          name = "Safari";
          version = ua.split("Version/")[1].split(" ")[0];
        } else if (ua.includes("Edg/")) {
          name = "Edge";
          version = ua.split("Edg/")[1];
        }
        return { name, version };
      }

      // Fun√ß√£o para extrair informa√ß√µes do dispositivo
      function extractDeviceInfo() {
        const ua = navigator.userAgent;
        const platform = navigator.platform;
        let model = "Desktop/Desconhecido";

        // Heur√≠stica simples para detectar modelo Android no User-Agent
        // Padr√£o comum: "Android ...; <Modelo> Build/..."
        if (ua.includes("Android")) {
          const match = ua.match(/Android.*?; (.*?) Build\//);
          if (match && match[1]) {
            model = match[1].trim();
          } else {
            model = "Android Generic";
          }
        } else if (ua.includes("iPhone") || ua.includes("iPad")) {
          model = "iOS Device";
        }

        const { name: browserName, version: browserVersion } = parseUserAgent(ua);
        const majorVersion = browserVersion.split('.')[0];

        return {
          userAgent: ua,
          platform: platform,
          model: model,
          browserName: browserName,
          browserVersion: browserVersion,
          majorVersion: majorVersion
        };
      }

      // Fun√ß√£o para gerar a chave de whitelist
      function generateDeviceKey(info) {
        // Remove espa√ßos do modelo e converte para min√∫sculas para a chave
        const cleanModel = info.model.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
        // Formato: <modelo>-chrome-<versao-major>
        // Nota: Usando 'chrome' fixo se for Chrome ou WebView baseado em Chromium, 
        // mas adaptando se for outro navegador.
        const browserKey = info.browserName.toLowerCase();
        return `${cleanModel}-${browserKey}-${info.majorVersion}`;
      }

      // Inicializa a se√ß√£o de informa√ß√µes do dispositivo
      function initDeviceInfo() {
        const info = extractDeviceInfo();
        const key = generateDeviceKey(info);

        document.getElementById('deviceModel').textContent = info.model;
        document.getElementById('deviceKey').textContent = key;
        document.getElementById('userAgentDisplay').textContent = info.userAgent;

        log(`üì± Dispositivo identificado: ${info.model}`);
        log(`üîë Chave gerada: ${key}`);
      }

      window.iniciarDiagnostico = iniciarDiagnostico;
      window.enviarDiagnostico = enviarDiagnostico;

      // Executa inicializa√ß√£o ao carregar
      initDeviceInfo();

    })();</script>
</body>

</html>